- name: Create keystore path
  become: yes
  file:
    name: "{{ keystore_root }}"
    state: directory
    owner: "{{ ansible_user }}"
    mode: 0700

- name: Keystore password file
  template:
    src: templates/password.j2
    dest: "{{ keystore_root }}/password"
    owner: "{{ ansible_user }}"
    mode: 0400
    force: yes

- set_fact:
    keystore_filename: "{{ keystore_root }}/UTC--{{ keystore_file_date }}--{{ private_ip }}"

- set_fact:
    keystore_address_filename: "{{ keystore_filename }}.address"

- name: Check keystore file
  stat:
    path: "{{ keystore_filename }}"
  register: keystore_file

- name: Check keystore address file
  stat:
    path: "{{ keystore_address_filename }}"
  register: keystore_address_file

- name: Create keystore file
  docker_container:
    name: create_keystore
    image: "{{ docker_repo_mkkeystore }}"
    recreate: yes
    pull: yes
    command:
      - "-o"
      - "/data"
      - "--key-label"
      - "{{ private_ip }}"
      - "--date-string"
      - "2017-07-01"
      - "{{ keystore_password }}"
      - "{{ private_ip }}"
      - "{{ keystore_priv_seed }}"
    state: started
    volumes:
      - "{{ keystore_root }}:/data"
      - /tmp:/tmp
  when: keystore_file.stat.exists == False or keystore_address_file.stat.exists == False

- name: Wait for keystore generation
  command: docker wait create_keystore
  when: keystore_file.stat.exists == False or keystore_address_file.stat.exists == False

- name: Remove keystore helper container
  docker_container:
    name: create_keystore
    state: absent
  when: keystore_file.stat.exists == False or keystore_address_file.stat.exists == False

- name: Fetch keystore address
  command: "cat {{ keystore_filename }}.address"
  changed_when: no
  register: keystore_address

- set_fact:
    keystore_address: "{{ keystore_address.stdout }}"
